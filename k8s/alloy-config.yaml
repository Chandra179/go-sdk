apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-config
  namespace: observability
data:
  config.alloy: |
    // ===================================
    // Logs Collection - Kubernetes pods
    // ===================================
    
    // Discover pods in dev namespace
    discovery.kubernetes "pods" {
      role = "pod"
      namespaces {
        names = ["dev"]
      }
    }

    // Read pod logs with better error handling
    loki.source.kubernetes "pods" {
      targets    = discovery.kubernetes.pods.targets
      forward_to = [loki.process.add_labels.receiver]
      
      // Reduce warnings during pod lifecycle changes
      client {
        backoff {
          min_period = "500ms"
          max_period = "5m"
          max_retries = 3
        }
      }
    }

    // Process logs and extract JSON fields
    loki.process "add_labels" {
      forward_to = [loki.write.local.receiver]

      stage.json {
        expressions = {
          level     = "level",
          trace_id  = "trace_id",
          span_id   = "span_id",
        }
      }

      stage.labels {
        values = {
          level    = "",
          trace_id = "",
          span_id  = "",
        }
      }
    }

    // Write logs to Loki
    loki.write "local" {
      endpoint {
        url = "http://loki.observability.svc.cluster.local:3100/loki/api/v1/push"
      }
    }

    // ===================================
    // OTLP Receiver for traces & metrics
    // ===================================
    
    otelcol.receiver.otlp "default" {
      grpc {
        endpoint = "0.0.0.0:4317"
      }

      http {
        endpoint = "0.0.0.0:4318"
      }

      output {
        traces  = [otelcol.exporter.otlp.jaeger.input]
        metrics = [otelcol.exporter.prometheus.default.input]
      }
    }

    // Export traces to Jaeger
    otelcol.exporter.otlp "jaeger" {
      client {
        endpoint = "jaeger.observability.svc.cluster.local:4317"
        tls {
          insecure = true
        }
      }
    }

    // Export metrics to Prometheus
    otelcol.exporter.prometheus "default" {
      forward_to = [prometheus.remote_write.local.receiver]
    }

    // Write metrics to Prometheus
    prometheus.remote_write "local" {
      endpoint {
        url = "http://prometheus.observability.svc.cluster.local:9090/api/v1/write"
      }
    }